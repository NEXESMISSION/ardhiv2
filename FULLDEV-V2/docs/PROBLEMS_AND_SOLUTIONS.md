# ูุดุงูู ุงููุธุงู ูุงูุญููู
# System Problems and Solutions

ูุฐุง ุงููุณุชูุฏ ููุซู ุฌููุน ุงููุดุงูู ุงููุญุชููุฉ ูู ูุธุงู ุฅุฏุงุฑุฉ ูุจูุนุงุช ุงูุฃุฑุงุถู ูุงูุญููู ุงูููุชุฑุญุฉ ููุง.

This document documents all potential problems in the land sales management system and their proposed solutions.

---

## ุฌุฏูู ุงููุญุชููุงุช / Table of Contents

1. [ูุดุงูู ุงูุญุงูุฉ ูุงูุชูุงุณู](#1-ูุดุงูู-ุงูุญุงูุฉ-ูุงูุชูุงุณู)
2. [ูุดุงูู ุงููุนุงููุงุช ูุงูุณุจุงู](#2-ูุดุงูู-ุงููุนุงููุงุช-ูุงูุณุจุงู)
3. [ูุดุงูู ูุงุฌูุฉ ุงููุณุชุฎุฏู](#3-ูุดุงูู-ูุงุฌูุฉ-ุงููุณุชุฎุฏู)
4. [ูุดุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช](#4-ูุดุงูู-ูุงุนุฏุฉ-ุงูุจูุงูุงุช)
5. [ูุดุงูู ุงูุฃุฏุงุก](#5-ูุดุงูู-ุงูุฃุฏุงุก)
6. [ูุดุงูู ุงูุฃูุงู](#6-ูุดุงูู-ุงูุฃูุงู)

---

## 1. ูุดุงูู ุงูุญุงูุฉ ูุงูุชูุงุณู
## 1. State and Consistency Problems

### 1.1. ุงูุญุฌุฒ ุงููุชูู (Orphaned Reservations)

**ุงููุดููุฉ:**
- ุงููุทุนุฉ ูู ุญุงูุฉ "ูุญุฌูุฒุฉ" (Reserved) ููู ูุง ููุฌุฏ ุจูุน ูุนูู (pending sale) ูุฑุชุจุท ุจูุง
- ูุญุฏุซ ูุฐุง ุนูุฏูุง:
  - ูุดู ุฅูุดุงุก ุงูุจูุน ุจุนุฏ ุญุฌุฒ ุงููุทุนุฉ
  - ุชู ุญุฐู ุงูุจูุน ุงููุนูู ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
  - ุญุฏุซ ุฎุทุฃ ูู ุงููุนุงููุฉ ููู ูุชู ุงูุชุฑุงุฌุน ุจุดูู ุตุญูุญ

**ุงูุฃุนุฑุงุถ:**
- ุงููุทุนุฉ ุชุธูุฑ ูู "ูุญุฌูุฒุฉ" ูู ุงููุงุฌูุฉ
- ูุง ูููู ุจูุน ุงููุทุนุฉ ูุฃููุง ูุญุฌูุฒุฉ
- ุตูุญุฉ ุงูุชุฃููุฏ ูุงุฑุบุฉ (ูุง ุชูุฌุฏ ูุจูุนุงุช ูุนููุฉ)
- ุฑุณุงูุฉ ุฎุทุฃ: "ุชุนุฐุฑ ุญุฌุฒ ุงููุทุนุฉ. ุงูุญุงูุฉ ุงูุญุงููุฉ: ูุญุฌูุฒุฉ"

**ุงูุญู ุงูุญุงูู:**
- ูุธููุฉ `cleanupOrphanedReservations()` ุชุนูู ุชููุงุฆูุงู ูู 30 ุซุงููุฉ ูู ุตูุญุฉ ุงูุชุฃููุฏ
- ูุธููุฉ `autoFixOrphanedReservation()` ุชุญุงูู ุฅุตูุงุญ ุงูุญุฌุฒ ุงููุชูู ูุจู ูู ุนูููุฉ ุจูุน
- ูุธููุฉ `cancelStalePendingSales()` ุชูุบู ุงููุจูุนุงุช ุงููุนููุฉ ุงููุฏููุฉ (ุฃูุซุฑ ูู ุณุงุนุฉ)

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุฅุถุงูุฉ ุขููุฉ ุชูุธูู ุชููุงุฆูุฉ ุนูุฏ ุชุญููู ุงููุทุน
2. โ ูุญุงููุฉ ุฅุตูุงุญ ุงูุญุฌุฒ ุงููุชูู ูุจู ูู ุนูููุฉ ุญุฌุฒ
3. โ ุฅุถุงูุฉ retry logic ูุน exponential backoff
4. โ๏ธ ุฅุถุงูุฉ database trigger ููุชุญูู ูู ุงูุชูุงุณู (ูุชุทูุจ ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)

---

### 1.2. ุนุฏู ุชุทุงุจู ุญุงูุฉ ุงููุทุนุฉ ูุน ุงููุจูุนุงุช
### 1.2. Piece Status Mismatch with Sales

**ุงููุดููุฉ:**
- ุญุงูุฉ ุงููุทุนุฉ ูุง ุชุทุงุจู ุญุงูุฉ ุงููุจูุนุงุช ุงููุฑุชุจุทุฉ ุจูุง
- ุฃูุซูุฉ:
  - ุงููุทุนุฉ "ูุชุงุญุฉ" ููู ูุฏููุง ุจูุน ูุนูู
  - ุงููุทุนุฉ "ูุญุฌูุฒุฉ" ููู ูุง ููุฌุฏ ุจูุน ูุนูู
  - ุงููุทุนุฉ "ูุจูุนุฉ" ููู ูุง ููุฌุฏ ุจูุน ููุชูู

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงุฆู ุฎุทุฃ ุบูุฑ ูุงุถุญุฉ
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุฅุชูุงู ุงูุนูููุงุช
- ุจูุงูุงุช ุบูุฑ ูุชุณูุฉ ูู ุงููุงุฌูุฉ

**ุงูุญู ุงูุญุงูู:**
- ูุธููุฉ `verifyPieceStatusConsistency()` ุชุชุญูู ูู ุงูุชูุงุณู
- ูุธููุฉ `fixPieceStatus()` ุชุญุงูู ุฅุตูุงุญ ุงูุญุงูุฉ ุชููุงุฆูุงู

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุงูุชุญูู ูู ุงูุชูุงุณู ูุจู ูู ุนูููุฉ ูููุฉ
2. โ ุฅุตูุงุญ ุชููุงุฆู ููุญุงูุงุช ุงูุจุณูุทุฉ
3. โ๏ธ ุฅุถุงูุฉ database constraints (ูุชุทูุจ ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
4. โ๏ธ ุฅุถุงูุฉ database triggers ููุชุญูู ุงูุชููุงุฆู

---

### 1.3. ุงููุจูุนุงุช ุงููุนููุฉ ุงููุฏููุฉ (Stale Pending Sales)

**ุงููุดููุฉ:**
- ูุจูุนุงุช ูุนููุฉ (pending) ูุฏููุฉ ุฌุฏุงู (ุฃูุซุฑ ูู ุณุงุนุฉ) ูุง ุชุฒุงู ููุฌูุฏุฉ
- ุชููุน ุจูุน ุงููุทุนุฉ ูุฑุฉ ุฃุฎุฑู
- ูุฏ ุชููู ูุชูุฌุฉ:
  - ุงููุณุชุฎุฏู ุฃุบูู ุงููุชุตูุญ ูุจู ุฅุชูุงู ุงูุจูุน
  - ุฎุทุฃ ูู ุงูุดุจูุฉ
  - ุนูููุฉ ุจูุน ุบูุฑ ููุชููุฉ

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุงููุทุนุฉ ูุญุฌูุฒุฉ ูุจูุน ูุนูู"
- ุตูุญุฉ ุงูุชุฃููุฏ ูุงุฑุบุฉ ุฃู ูุง ุชุธูุฑ ุงููุจูุนุงุช ุงููุฏููุฉ
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุจูุน ุงููุทุนุฉ

**ุงูุญู ุงูุญุงูู:**
- ูุธููุฉ `cancelStalePendingSales()` ุชูุบู ุงููุจูุนุงุช ุงููุฏููุฉ (ุฃูุซุฑ ูู ุณุงุนุฉ)
- ุชุนูู ุชููุงุฆูุงู ูุจู ูู ูุญุงููุฉ ุจูุน

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุฅูุบุงุก ุงููุจูุนุงุช ุงููุฏููุฉ ุชููุงุฆูุงู
2. โ ุชูุธูู ุฏูุฑู ูู 30 ุซุงููุฉ
3. โ๏ธ ุฅุถุงูุฉ ุขููุฉ ูุฅุดุนุงุฑ ุงููุณุชุฎุฏู ูุจู ุงูุฅูุบุงุก
4. โ๏ธ ุญูุธ ุงููุจูุนุงุช ุงูููุบุงุฉ ูู ุฌุฏูู ูููุตู ููุชุฏููู

---

## 2. ูุดุงูู ุงููุนุงููุงุช ูุงูุณุจุงู
## 2. Transaction and Race Condition Problems

### 2.1. Race Condition ูู ุญุฌุฒ ุงููุทุนุฉ
### 2.1. Race Condition in Piece Reservation

**ุงููุดููุฉ:**
- ูุญุงููุฉ ุญุฌุฒ ุงููุทุนุฉ ูู ูุจู ูุณุชุฎุฏููู ูุชุนุฏุฏูู ูู ููุณ ุงูููุช
- ุฃู ูุญุงููุฉ ุญุฌุฒ ุงููุทุนุฉ ุจูููุง ูุชู ุชูุธูู ุงูุญุฌุฒ ุงููุชูู
- Supabase ูุง ูุฏุนู ุงููุนุงููุงุช ุงูุญููููุฉ (true transactions)

**ุงูุฃุนุฑุงุถ:**
- ุฑุณุงูุฉ: "ุชุนุฐุฑ ุญุฌุฒ ุงููุทุนุฉ. ุงูุญุงูุฉ ุงูุญุงููุฉ: ูุญุฌูุฒุฉ"
- ูุดู ุนูููุฉ ุงูุจูุน ุญุชู ูู ูุงูุช ุงููุทุนุฉ ูุชุงุญุฉ
- ุงูุญุงูุฉ ุชุชุบูุฑ ุจูู ุงูุชุญูู ูุงููุญุงููุฉ

**ุงูุญู ุงูุญุงูู:**
- ุงุณุชุฎุฏุงู Optimistic Locking: `.eq('status', 'Available')` ูุจู ุงูุชุญุฏูุซ
- Retry logic ูุน exponential backoff (ุญุชู 3 ูุญุงููุงุช)
- ุฅุตูุงุญ ุงูุญุฌุฒ ุงููุชูู ูุจู ูู ูุญุงููุฉ

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุงุณุชุฎุฏุงู Optimistic Locking
2. โ Retry logic ูุน ุชุฃุฎูุฑ ูุชุฒุงูุฏ
3. โ ุฅุตูุงุญ ุงูุญุฌุฒ ุงููุชูู ูุจู ุงููุญุงููุฉ
4. โ๏ธ ุฅุถุงูุฉ row-level locking ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุชุทูุจ ุชุนุฏูู)
5. โ๏ธ ุงุณุชุฎุฏุงู Redis ููู distributed locking (ูููุณุชูุจู)

---

### 2.2. ูุดู ุงููุนุงููุฉ ูุงูุชุฑุงุฌุน
### 2.2. Transaction Failure and Rollback

**ุงููุดููุฉ:**
- ูุดู ุฃุญุฏ ุฎุทูุงุช ุงููุนุงููุฉ (ูุซู: ุญุฌุฒ ุงููุทุนุฉ ูุฌุญ ููู ุฅูุดุงุก ุงูุจูุน ูุดู)
- ุงูุชุฑุงุฌุน (rollback) ูุฏ ููุดู ุฃูุถุงู
- Supabase ูุง ูุฏุนู ุงููุนุงููุงุช ุงูุญููููุฉ

**ุงูุฃุนุฑุงุถ:**
- ุจูุงูุงุช ุบูุฑ ูุชุณูุฉ
- ูุทุน ูุญุฌูุฒุฉ ุจุฏูู ูุจูุนุงุช
- ูุจูุนุงุช ุจุฏูู ูุทุน ูุญุฌูุฒุฉ

**ุงูุญู ุงูุญุงูู:**
- ุงุณุชุฎุฏุงู `executeTransaction()` ูุน rollback functions
- ูู ุนูููุฉ ููุง rollback function ุฎุงุตุฉ ุจูุง
- ุงูุชุฑุงุฌุน ูุชู ุจุชุฑุชูุจ ุนูุณู

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ Rollback functions ููู ุนูููุฉ
2. โ ุงูุชุฑุงุฌุน ุจุชุฑุชูุจ ุนูุณู
3. โ ุชุณุฌูู ุงูุฃุฎุทุงุก ูู console
4. โ๏ธ ุฅุถุงูุฉ audit log ูุฌููุน ุงูุนูููุงุช
5. โ๏ธ ุฅุถุงูุฉ ุขููุฉ recovery ุชููุงุฆูุฉ

---

### 2.3. ุชุฑุชูุจ ุงูุนูููุงุช ูู ุงููุนุงููุฉ
### 2.3. Operation Order in Transaction

**ุงููุดููุฉ:**
- ุงูุชุฑุชูุจ ุงูุฎุงุทุฆ ููุนูููุงุช ูุณุจุจ ูุดุงูู
- ูุซุงู: ุฅูุดุงุก ุงูุจูุน ูุจู ุญุฌุฒ ุงููุทุนุฉ ูุณุจุจ race condition

**ุงูุญู ุงูุญุงูู:**
- โ ุญุฌุฒ ุงููุทุนุฉ ุฃููุงูุ ุซู ุฅูุดุงุก ุงูุจูุน
- โ ุฅุฐุง ูุดู ุฅูุดุงุก ุงูุจูุนุ ูุชู ุงูุชุฑุงุฌุน ุนู ุงูุญุฌุฒ

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุงูุชุฑุชูุจ ุงูุตุญูุญ: Reserve โ Create Sale
2. โ ุงูุชุญูู ูู ูู ุฎุทูุฉ ูุจู ุงููุชุงุจุนุฉ
3. โ๏ธ ุฅุถุงูุฉ validation ูู ูู ุฎุทูุฉ

---

## 3. ูุดุงูู ูุงุฌูุฉ ุงููุณุชุฎุฏู
## 3. User Interface Problems

### 3.1. ุนุฏู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุนุฏ ุงูุนูููุงุช
### 3.1. Data Not Refreshing After Operations

**ุงููุดููุฉ:**
- ุจุนุฏ ุฅูุดุงุก ุจูุนุ ุงูุตูุญุงุช ุงูุฃุฎุฑู ูุง ุชุชุญุฏุซ ุชููุงุฆูุงู
- ุงููุณุชุฎุฏู ูุฑู ุจูุงูุงุช ูุฏููุฉ

**ุงูุฃุนุฑุงุถ:**
- ุตูุญุฉ ุงูุชุฃููุฏ ูุงุฑุบุฉ ุจุนุฏ ุฅูุดุงุก ุจูุน
- ุตูุญุฉ ุณุฌู ุงููุจูุนุงุช ูุง ุชุธูุฑ ุงููุจูุนุงุช ุงูุฌุฏูุฏุฉ
- ุญุงูุฉ ุงููุทุนุฉ ูุง ุชุชุญุฏุซ ูู ุงููุงุฌูุฉ

**ุงูุญู ุงูุญุงูู:**
- ุงุณุชุฎุฏุงู Custom Events: `saleCreated`
- ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ูู ุนูููุฉ
- `setTimeout` ูุฅุนุงุฏุฉ ูุชุญ ุงูุญูุงุฑุงุช

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ Custom Events ููุชูุงุตู ุจูู ุงูุตูุญุงุช
2. โ ุฅุนุงุฏุฉ ุชุญููู ุงูุจูุงูุงุช ุจุนุฏ ุงูุนูููุงุช
3. โ๏ธ ุงุณุชุฎุฏุงู React Context ุฃู State Management
4. โ๏ธ ุฅุถุงูุฉ WebSocket ููู real-time updates

---

### 3.2. ุฑุณุงุฆู ุงูุฎุทุฃ ุบูุฑ ุงููุงุถุญุฉ
### 3.2. Unclear Error Messages

**ุงูุญุงูุฉ:** ๐ข ูุญููู

**ุงููุดููุฉ:**
- ุฑุณุงุฆู ุงูุฎุทุฃ ุชูููุฉ ุฌุฏุงู
- ูุง ุชูุถุญ ูููุณุชุฎุฏู ูุง ูุฌุจ ูุนูู

**ูุง ุชู ูุนูู:**
- โ ุฅูุดุงุก `errorMessages.ts` utility ูุชูุณูู ุฑุณุงุฆู ุงูุฎุทุฃ
- โ ุชุฑุฌูุฉ ุงูุฃุฎุทุงุก ุงูุดุงุฆุนุฉ ุฅูู ุฑุณุงุฆู ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
- โ ุฅุถุงูุฉ ุฅุฑุดุงุฏุงุช ูุงุจูุฉ ููุชูููุฐ ููู ููุน ุฎุทุฃ
- โ ุฅุถุงูุฉ retry logic ุชููุงุฆู ููุฃุฎุทุงุก ุงููุงุจูุฉ ููุฅุนุงุฏุฉ (network, status changes)
- โ ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ ูู ุฌููุน ุงูุนูููุงุช ุงูุฑุฆูุณูุฉ:
  - ุฅูุดุงุก ุงูุจูุน
  - ุชุฃููุฏ ุงูุจูุน
  - ุฑูุถ ุงูุจูุน
  - ุฅูุบุงุก ุงูุจูุน
  - ุฅุฑุฌุงุน ุงูุจูุน

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุฅุถุงูุฉ tooltips ุชูุถูุญูุฉ ูู ุงููุณุชูุจู

---

### 3.3. ุญุงูุฉ ุงูุชุญููู ูุงูุงูุชุธุงุฑ
### 3.3. Loading and Waiting States

**ุงูุญุงูุฉ:** ๐ข ูุญููู

**ุงููุดููุฉ:**
- ุนุฏู ูุถูุญ ูุชู ุชููู ุงูุนูููุฉ ููุฏ ุงูุชูููุฐ
- ุงููุณุชุฎุฏู ูุฏ ูุญุงูู ุนุฏุฉ ูุฑุงุช

**ูุง ุชู ูุนูู:**
- โ ุฅุถุงูุฉ `confirming` ู `rejecting` states ูู ุตูุญุฉ ุงูุชุฃููุฏ
- โ ุชุนุทูู ุงูุฃุฒุฑุงุฑ ุฃุซูุงุก ุงููุนุงูุฌุฉ ูู ุฌููุน ุงูุญูุงุฑุงุช
- โ ุนุฑุถ "ุฌุงุฑู ุงููุนุงูุฌุฉ..." ุนูู ุงูุฃุฒุฑุงุฑ ุฃุซูุงุก ุงูุนูููุงุช
- โ ููุน ุฅุบูุงู ุงูุญูุงุฑุงุช ุฃุซูุงุก ุงููุนุงูุฌุฉ
- โ ุงุณุชุฎุฏุงู `saving` state ูู ConfirmationDialog
- โ ุงุณุชุฎุฏุงู `loading` prop ูู ConfirmDialog

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุฅุถุงูุฉ progress bars ููุนูููุงุช ุงูุทูููุฉ ูู ุงููุณุชูุจู
- โ๏ธ ูููู ุฅุถุงูุฉ timeout warnings ููุนูููุงุช ุงูุชู ุชุณุชุบุฑู ููุชุงู ุทูููุงู

---

### 3.4. ุญุงูุฉ ุงููุทุนุฉ ูุง ุชุนูุณ ุงูุญุงูุฉ ุงูุญููููุฉ
### 3.4. Piece Status Not Reflecting Real-Time State

**ุงูุญุงูุฉ:** ๐ข ูุญููู

**ุงููุดููุฉ:**
- ุญุงูุฉ ุงููุทุนุฉ ุงููุนุฑูุถุฉ ูู ุงููุงุฌูุฉ ูุง ุชุนูุณ ุงูุญุงูุฉ ุงูุญููููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ูุญุชุงุฌ ุงููุณุชุฎุฏู ูุชุญุฏูุซ ุงูุตูุญุฉ ูุฏููุงู ูุฑุคูุฉ ุงูุชุบููุฑุงุช
- ุงูุญุงูุฉ ูุง ุชุชุญุฏุซ ุชููุงุฆูุงู ุนูุฏ ุญุฏูุซ ุนูููุงุช

**ูุง ุชู ูุนูู:**
- โ ุฅูุดุงุก `getRealTimePieceStatus()` ู `getRealTimePieceStatuses()` ููุชุญูู ูู ุงูุญุงูุฉ ุงูุญููููุฉ
- โ ุงูุชุญูู ูู ูู ูู ุฌุฏูู `land_pieces` ูุฌุฏูู `sales` ูุชุญุฏูุฏ ุงูุญุงูุฉ ุงูุตุญูุญุฉ
- โ ุชุญุฏูุซ `loadPieces()` ูู Land.tsx ู PieceDialog.tsx ูุงุณุชุฎุฏุงู ุงูุญุงูุฉ ุงูุญููููุฉ
- โ ุฅุถุงูุฉ event listeners ูุชุญุฏูุซ ุงูุญุงูุฉ ุชููุงุฆูุงู ุนูุฏ:
  - ุฅูุดุงุก ุจูุน (`saleCreated`)
  - ุชุฃููุฏ ุจูุน (`saleConfirmed`)
  - ุฅูุบุงุก/ุฑูุถ ุจูุน (`saleCancelled`)
  - ุชุญุฏูุซ ุจูุน (`saleUpdated`)
  - ุชุบููุฑ ุญุงูุฉ ูุทุนุฉ (`pieceStatusChanged`)
- โ ุฅุถุงูุฉ ุชุญุฏูุซ ุฏูุฑู ููุญุงูุฉ ูู 10-15 ุซุงููุฉ ูู ุงูุญูุงุฑุงุช ุงูููุชูุญุฉ
- โ ุงูุญุงูุฉ ุงูุขู ุชุนูุณ:
  - `Sold` ุฅุฐุง ูุงู ููุงู ุจูุน ููุชูู
  - `Reserved` ุฅุฐุง ูุงู ููุงู ุจูุน ูุนูู
  - `Available` ุฅุฐุง ูู ููู ููุงู ูุจูุนุงุช

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุฅุถุงูุฉ WebSocket ููู real-time updates ุงูููุฑูุฉ ุจุฏูู polling

---

## 4. ูุดุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
## 4. Database Problems

### 4.1. ุนุฏู ูุฌูุฏ Constraints ูุงููุฉ
### 4.1. Insufficient Database Constraints

**ุงููุดููุฉ:**
- ูุง ุชูุฌุฏ constraints ุชููุน ุงูุจูุงูุงุช ุบูุฑ ุงููุชุณูุฉ
- ูููู ุฅูุดุงุก ูุจูุนุงุช ุจุฏูู ูุทุน
- ูููู ุฅูุดุงุก ูุจูุนุงุช ููุฑุฑุฉ

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ UNIQUE constraint ุนูู `land_piece_id` ูู `sales` (ููู status)
2. โ๏ธ ุฅุถุงูุฉ CHECK constraints ููุชุญูู ูู ุงูุญุงูุฉ
3. โ๏ธ ุฅุถุงูุฉ FOREIGN KEY constraints
4. โ๏ธ ุฅุถุงูุฉ database triggers ููุชุญูู ุงูุชููุงุฆู

---

### 4.2. ุนุฏู ูุฌูุฏ Indexes
### 4.2. Missing Database Indexes

**ุงููุดููุฉ:**
- ุงุณุชุนูุงูุงุช ุจุทูุฆุฉ ุนูู ุฌุฏุงูู ูุจูุฑุฉ
- ุงูุจุญุซ ุนู ุงููุจูุนุงุช ุงููุนููุฉ ุจุทูุก

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ index ุนูู `land_piece_id` ูู `sales`
2. โ๏ธ ุฅุถุงูุฉ index ุนูู `status` ูู `sales`
3. โ๏ธ ุฅุถุงูุฉ composite index ุนูู `(land_piece_id, status)`
4. โ๏ธ ุฅุถุงูุฉ index ุนูู `created_at` ูู `sales`

---

### 4.3. ุนุฏู ูุฌูุฏ Soft Deletes
### 4.3. Missing Soft Deletes

**ุงููุดููุฉ:**
- ุญุฐู ุงูุจูุงูุงุช ููุงุฆูุงู ูููุฏ ุงูุณุฌู ุงูุชุงุฑูุฎู
- ุตุนูุจุฉ ูู ุงูุชุฏููู ูุงูุชุญููู

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ `deleted_at` column
2. โ๏ธ ุงุณุชุฎุฏุงู soft deletes ุจุฏูุงู ูู hard deletes
3. โ๏ธ ุฅุถุงูุฉ ูุธููุฉ ูุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงููุญุฐููุฉ

---

## 5. ูุดุงูู ุงูุฃุฏุงุก
## 5. Performance Problems

### 5.1. ุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ ุบูุฑ ุถุฑูุฑูุฉ
### 5.1. Unnecessary Multiple Queries

**ุงููุดููุฉ:**
- ุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ ููุญุตูู ุนูู ุจูุงูุงุช ูููู ุฌูุจูุง ูู ุงุณุชุนูุงู ูุงุญุฏ
- N+1 query problem

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ ุงุณุชุฎุฏุงู Supabase joins (`.select()` ูุน relations)
2. โ๏ธ ุฅุถุงูุฉ caching ููุจูุงูุงุช ุงูุชู ูุง ุชุชุบูุฑ ูุซูุฑุงู
3. โ๏ธ ุงุณุชุฎุฏุงู batch operations

---

### 5.2. ุนุฏู ูุฌูุฏ Pagination
### 5.2. Missing Pagination

**ุงููุดููุฉ:**
- ุฌูุจ ุฌููุน ุงูุจูุงูุงุช ุฏูุนุฉ ูุงุญุฏุฉ
- ุจุทุก ูู ุงูุตูุญุงุช ูุน ุจูุงูุงุช ูุซูุฑุฉ

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ pagination ููููุงุฆู
2. โ๏ธ ุฅุถุงูุฉ infinite scroll
3. โ๏ธ ุฅุถุงูุฉ virtual scrolling

---

### 5.3. ุนุฏู ูุฌูุฏ Caching
### 5.3. Missing Caching

**ุงููุดููุฉ:**
- ุฌูุจ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ูุฑุฉ
- ุจุทุก ูู ุงูุชุญููู

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ React Query ุฃู SWR ููู caching
2. โ๏ธ ุฅุถุงูุฉ localStorage ููุจูุงูุงุช ุงูุซุงุจุชุฉ
3. โ๏ธ ุฅุถุงูุฉ service worker ููู offline support

---

## 6. ูุดุงูู ุงูุฃูุงู
## 6. Security Problems

### 6.1. ุนุฏู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
### 6.1. Missing Permission Checks

**ุงููุดููุฉ:**
- ูุง ุชูุฌุฏ ุขููุฉ ููุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู
- ุฃู ูุณุชุฎุฏู ููููู ุฅูุดุงุก/ุญุฐู/ุชุนุฏูู ุฃู ุดูุก

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ๏ธ ุฅุถุงูุฉ Row Level Security (RLS) ูู Supabase
2. โ๏ธ ุฅุถุงูุฉ role-based access control
3. โ๏ธ ุฅุถุงูุฉ authentication system

---

### 6.2. ุนุฏู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
### 6.2. Missing Input Validation

**ุงููุดููุฉ:**
- ุงูุจูุงูุงุช ุงููุฏุฎูุฉ ูุฏ ุชููู ุบูุฑ ุตุญูุญุฉ
- ูุฏ ุชุณุจุจ ุฃุฎุทุงุก ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู ุงูุญุงูู:**
- โ Validation ูู ุงููุงุฌูุฉ (React)
- โ Validation ูู `handleFinalizeSale`

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ Client-side validation
2. โ๏ธ Server-side validation (Supabase functions)
3. โ๏ธ Database-level validation (constraints)

---

### 6.3. ุนุฏู ูุฌูุฏ Audit Log
### 6.3. Missing Audit Log

**ุงููุดููุฉ:**
- ูุง ููุฌุฏ ุณุฌู ูุฌููุน ุงูุนูููุงุช
- ุตุนูุจุฉ ูู ุชุชุจุน ุงูุชุบููุฑุงุช

**ุงูุญู ุงูุญุงูู:**
- โ `auditLog.ts` ูุน ูุธุงุฆู `logPieceStatusChange`, `logSaleConfirmation`, etc.

**ุงูุญููู ุงูููุชุฑุญุฉ:**
1. โ Audit log functions ููุฌูุฏุฉ
2. โ๏ธ ุฅุถุงูุฉ UI ูุนุฑุถ ุณุฌู ุงูุชุฏููู
3. โ๏ธ ุฅุถุงูุฉ export ููู audit logs

---

## 7. ุงููุดุงูู ุงูุญุงููุฉ ุงููุนุฑููุฉ
## 7. Current Known Issues

### 7.1. Race Condition ูู ุญุฌุฒ ุงููุทุนุฉ
**ุงูุญุงูุฉ:** ๐ข ูุญููู
**ุงูุฃููููุฉ:** ุนุงููุฉ
**ุงููุตู:** 
- ุงููุทุนุฉ ุชุธูุฑ ูู "ูุชุงุญุฉ" ููู ุนูุฏ ูุญุงููุฉ ุงูุจูุน ุชุธูุฑ ูู "ูุญุฌูุฒุฉ"
- ูุงู ูุญุฏุซ ุจุณุจุจ race condition ุจูู cleanup ู reservation
- ุงูุญู ุงูุญุงูู: retry logic ูุน exponential backoff + ูุชุฑุฉ ุณูุงุญ 2 ุฏูููุฉ ุชููุน ุงูู cleanup ูู ููุณ ุงูุญุฌูุฒุงุช ุงูุฌุฏูุฏุฉ

**ูุง ุชู ูุนูู:**
- ููุน `cleanupOrphanedReservations` ูู ุชุญุฑูุฑ ุงูุญุฌูุฒุงุช ุงูุชู ุชู ุชุญุฏูุซูุง ุฎูุงู ุขุฎุฑ ุฏูููุชูู ูุชุฌูุจ ุงูุชุถุงุฑุจ ูุน ุฅูุดุงุก ุงูุจูุน
- ุงูุญูุงุธ ุนูู retry logic ุงูุญุงููุฉ

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุฅุถุงูุฉ database-level locking ุฃู queue ูู ุงููุณุชูุจู ูุฒูุงุฏุฉ ุงูุถูุงู

---

### 7.2. ุงููุจูุนุงุช ุงููุนููุฉ ุงููุฏููุฉ
**ุงูุญุงูุฉ:** ๐ข ูุญููู
**ุงูุฃููููุฉ:** ูุชูุณุทุฉ
**ุงููุตู:**
- ูุจูุนุงุช ูุนููุฉ ูุฏููุฉ (ุฃูุซุฑ ูู ุณุงุนุฉ) ูุง ุชุฒุงู ููุฌูุฏุฉ
- ุชููุน ุจูุน ุงููุทุนุฉ ูุฑุฉ ุฃุฎุฑู

**ูุง ุชู ูุนูู:**
- โ ุฅุถุงูุฉ ูุธููุฉ `cleanupAllStalePendingSales()` ููุชูุธูู ุงูุดุงูู ูุฌููุน ุงููุจูุนุงุช ุงููุฏููุฉ
- โ ุฏูุฌ ุงูุชูุธูู ุงูุดุงูู ูู ุงูุชูุธูู ุงูุฏูุฑู ูู 30 ุซุงููุฉ ูู ุตูุญุฉ ุงูุชุฃููุฏ
- โ ุฅุถุงูุฉ audit logging ุนูุฏ ุฅูุบุงุก ุงููุจูุนุงุช ุงููุฏููุฉ
- โ ุฅุตูุงุญ ุชููุงุฆู ูุญุงูุฉ ุงููุทุน ุจุนุฏ ุฅูุบุงุก ุงููุจูุนุงุช ุงููุฏููุฉ
- โ `cancelStalePendingSales()` ุชุนูู ุชููุงุฆูุงู ูุจู ูู ูุญุงููุฉ ุจูุน

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุฅุถุงูุฉ database trigger ููุฅูุบุงุก ุงูุชููุงุฆู ูู ุงููุณุชูุจู (ูุชุทูุจ ุชุนุฏูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)
- โ๏ธ ูููู ุฅุถุงูุฉ notification system ูููุณุชุฎุฏู ูุจู ุงูุฅูุบุงุก

---

### 7.3. ุนุฏู ุชุญุฏูุซ ุงูุตูุญุงุช ุจุนุฏ ุงูุนูููุงุช
**ุงูุญุงูุฉ:** ๐ข ูุญููู
**ุงูุฃููููุฉ:** ูุชูุณุทุฉ
**ุงููุตู:**
- ุจุนุฏ ุฅูุดุงุก ุจูุนุ ุงูุตูุญุงุช ุงูุฃุฎุฑู ูุง ุชุชุญุฏุซ ุชููุงุฆูุงู
- ูุญุชุงุฌ ุงููุณุชุฎุฏู ูุชุญุฏูุซ ุงูุตูุญุฉ ูุฏููุงู

**ูุง ุชู ูุนูู:**
- โ ุฅุถุงูุฉ event listeners ูู ุฌููุน ุงูุตูุญุงุช ููุงุณุชูุงุน ููุฃุญุฏุงุซ:
  - `saleCreated` - ุนูุฏ ุฅูุดุงุก ุจูุน ุฌุฏูุฏ
  - `saleConfirmed` - ุนูุฏ ุชุฃููุฏ ุจูุน
  - `saleCancelled` - ุนูุฏ ุฅูุบุงุก/ุฑูุถ ุจูุน
  - `saleReverted` - ุนูุฏ ุฅุฑุฌุงุน ุจูุน ุฅูู ุญุงูุฉ ุงูุงูุชุธุงุฑ
  - `saleUpdated` - ุนูุฏ ุชุญุฏูุซ ุฃู ุจูุน
  - `pieceStatusChanged` - ุนูุฏ ุชุบููุฑ ุญุงูุฉ ูุทุนุฉ
- โ ุฅุถุงูุฉ event dispatching ูู ุฌููุน ุงูุนูููุงุช:
  - ุฅูุดุงุก ุจูุน (Land.tsx)
  - ุชุฃููุฏ ุจูุน (Confirmation.tsx)
  - ุฑูุถ ุจูุน (Confirmation.tsx)
  - ุฅูุบุงุก ุจูุน (SalesRecords.tsx)
  - ุฅุฑุฌุงุน ุจูุน (SalesRecords.tsx)
- โ ุฌููุน ุงูุตูุญุงุช ุชุชุญุฏุซ ุชููุงุฆูุงู ุนูุฏ ุญุฏูุซ ุฃู ุชุบููุฑ

**ุงูุญุงูุฉ ุงููุชุจููุฉ/ุงููุณุชูุจููุฉ:**
- โ๏ธ ูููู ุงุณุชุฎุฏุงู React Context ุฃู State Management ูู ุงููุณุชูุจู ูุชุญุณูู ุงูุฃุฏุงุก
- โ๏ธ ูููู ุฅุถุงูุฉ WebSocket ููู real-time updates ูููุณุชุฎุฏููู ุงููุชุนุฏุฏูู

---

## 8. ุฎุทุฉ ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ
## 8. Future Improvement Plan

### ุงููุฑุญูุฉ 1: ุฅุตูุงุญุงุช ุนุงุฌูุฉ (ุฃุณุจูุน 1-2)
1. โ ุชุญุณูู retry logic ูู ุญุฌุฒ ุงููุทุนุฉ
2. โ ุฅุถุงูุฉ ุงููุฒูุฏ ูู cleanup checks
3. โ๏ธ ุฅุถุงูุฉ database indexes
4. โ๏ธ ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ

### ุงููุฑุญูุฉ 2: ุชุญุณููุงุช ูุชูุณุทุฉ (ุฃุณุจูุน 3-4)
1. โ๏ธ ุฅุถุงูุฉ database constraints
2. โ๏ธ ุฅุถุงูุฉ pagination
3. โ๏ธ ุฅุถุงูุฉ caching
4. โ๏ธ ุชุญุณูู UI/UX

### ุงููุฑุญูุฉ 3: ุชุญุณููุงุช ุทูููุฉ ุงููุฏู (ุดูุฑ 2-3)
1. โ๏ธ ุฅุถุงูุฉ authentication system
2. โ๏ธ ุฅุถุงูุฉ Row Level Security
3. โ๏ธ ุฅุถุงูุฉ WebSocket ููู real-time updates
4. โ๏ธ ุฅุถุงูุฉ comprehensive testing

---

## 9. ููููุฉ ุงูุฅุจูุงุบ ุนู ูุดุงูู ุฌุฏูุฏุฉ
## 9. How to Report New Problems

ุนูุฏ ุงูุชุดุงู ูุดููุฉ ุฌุฏูุฏุฉ:

1. **ูุซู ุงููุดููุฉ:**
   - ูุตู ูุงุถุญ ูููุดููุฉ
   - ุฎุทูุงุช ูุฅุนุงุฏุฉ ุฅูุชุงุฌ ุงููุดููุฉ
   - ุฑุณุงุฆู ุงูุฎุทุฃ (ุฅู ูุฌุฏุช)
   - ููุทุงุช ุงูุดุงุดุฉ (ุฅู ุฃููู)

2. **ุชุญูู ูู ุงููุดุงูู ุงููุนุฑููุฉ:**
   - ุฑุงุฌุน ูุฐุง ุงููุณุชูุฏ ุฃููุงู
   - ุชุญูู ูู `known_issues.md`

3. **ุฃุถู ุงููุดููุฉ:**
   - ุฃุถููุง ูู ูุณู "ุงููุดุงูู ุงูุญุงููุฉ ุงููุนุฑููุฉ"
   - ุญุฏุฏ ุงูุฃููููุฉ ูุงูุญุงูุฉ

---

## 10. ููุงุญุธุงุช ูููุฉ
## 10. Important Notes

- โ = ุชู ุงูุชูููุฐ
- โ๏ธ = ููุชุฑุญ/ูุฎุทุท
- ๐ด = ูุดููุฉ ูุดุทุฉ/ุญุฑุฌุฉ
- ๐ก = ูุดููุฉ ุฌุฒุฆูุฉ/ูุชูุณุทุฉ
- ๐ข = ูุดููุฉ ูุญูููุฉ

**ุขุฎุฑ ุชุญุฏูุซ:** [ุชุงุฑูุฎ ุงูููู]
**ุงูุฅุตุฏุงุฑ:** 1.0.0

